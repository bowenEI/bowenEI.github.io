{{/*
VexFlow shortcode for rendering music notation
Usage: 
{{< vexflow id="unique-id" >}}
```js
const score = vf.EasyScore();
const system = vf.System();
// Your VexFlow code here...
```
{{< /vexflow >}}

Parameters:
- id (optional): unique identifier for the container div
- width (optional): width of the music canvas
- height (optional): height of the music canvas
*/}}

{{- $id := .Get "id" | default (printf "vexflow-%d" now.UnixNano) -}}
{{- $width := .Get "width" | default "500" -}}
{{- $height := .Get "height" | default "200" -}}

{{/* Process inner content to remove markdown code block syntax */}}
{{- $innerContent := .Inner -}}
{{- $innerContent = $innerContent | replaceRE "(?s)```\\s*(?:js|javascript)?\\s*\n?" "" -}}
{{- $innerContent = $innerContent | replaceRE "(?s)\n?```\\s*$" "" -}}
{{- $innerContent = strings.TrimSpace $innerContent -}}

{{/* Load VexFlow script only once per page - use local theme asset */}}
{{- if not (.Page.Store.Get "vexflow-loaded") -}}
  {{- $vexflowJS := resources.Get "js/vexflow.js" -}}
  {{- if $vexflowJS -}}
    {{- $vexflowJS = $vexflowJS | resources.Minify -}}
    <script src="{{ $vexflowJS.RelPermalink }}"></script>
  {{- else -}}
    {{/* Fallback to CDN if local asset not found */}}
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
  {{- end -}}
  {{- .Page.Store.Set "vexflow-loaded" true -}}
{{- end -}}

<div id="{{ $id }}" style="background-color: transparent; padding: 1em; background-clip: content-box; background-color: #f0f0f0;"></div>
<script>
  (function() {
    try {
      const { Factory } = Vex.Flow;
      const vf = new Factory({ 
        renderer: { 
          elementId: '{{ $id }}',
          // width: {{ $width }},
          // height: {{ $height }}
        }
      });
      const score = vf.EasyScore();
      const system = vf.System();
      // User's VexFlow code (processed to remove markdown syntax)
      {{ $innerContent | safeJS }}
      // Draw the notation
      vf.draw();
    } catch (error) {
      console.error('VexFlow rendering error:', error);
      document.getElementById('{{ $id }}').innerHTML = '<p style="color: red;">Music notation rendering failed: ' + error.message + '</p>';
    }
  })();
</script>
