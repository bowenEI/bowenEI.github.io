{{/*
VexFlow shortcode for rendering music notation
Usage: 
{{< vexflow id="unique-id" >}}
```js
const score = vf.EasyScore();
const system = vf.System();
// Your VexFlow code here...
```
{{< /vexflow >}}

Parameters:
- id (optional): unique identifier for the container div
- width (optional): width of the music canvas
- height (optional): height of the music canvas
*/}}

{{- $id := .Get "id" | default (printf "vexflow-%d" now.UnixNano) -}}
{{- $title:= .Get "title" | default "" -}}

{{/* Process inner content to remove markdown code block syntax */}}
{{- $innerContent := .Inner -}}
{{- $innerContent = $innerContent | replaceRE "(?s)```\\s*(?:js|javascript)?\\s*\n?" "" -}}
{{- $innerContent = $innerContent | replaceRE "(?s)\n?```\\s*$" "" -}}
{{- $innerContent = strings.TrimSpace $innerContent -}}

{{/* Load VexFlow script only once per page - use local theme asset */}}
{{- if not (.Page.Store.Get "vexflow-loaded") -}}
  {{- $vexflowJS := resources.Get "js/vexflow.js" -}}
  {{- if $vexflowJS -}}
    {{- $vexflowJS = $vexflowJS | resources.Minify -}}
    <script src="{{ $vexflowJS.RelPermalink }}"></script>
  {{- else -}}
    {{/* Fallback to CDN if local asset not found */}}
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
  {{- end -}}
  {{- .Page.Store.Set "vexflow-loaded" true -}}
{{- end -}}

<figure>
  <div id="{{ $id }}" style="background-color: white; border-radius: 6px; margin-block: 1rem;"></div>
  <script>
    (function() {
      try {
        // User's VexFlow code (processed to remove markdown syntax)
        {{ $innerContent | safeJS }}
      } catch (error) {
        console.error('VexFlow rendering error:', error);
        document.getElementById('{{ $id }}').innerHTML = '<p style="color: red;">Music notation rendering failed: ' + error.message + '</p>';
      }
    })();
  </script>
  {{- if $title -}}
    <figcaption>{{ $title }}</figcaption>
  {{- end -}}
</figure>
